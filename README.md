# 基于饱和度的图像去雾算法硬件实现

## 项目简介

本项目是一个基于饱和度的实时图像去雾算法的硬件实现，参考论文 *"VLSI Design of Saturation-Based Image Dehazing Algorithm"*。该算法通过分析图像的饱和度特征来估计场景的透射率，从而实现高质量的去雾效果。

### 核心特点

- **实时处理能力**：采用流水线架构，支持像素流式处理
- **硬件友好设计**：避免复杂的浮点运算和排序操作
- **资源优化**：通过滤波器分解和查找表(LUT)减少硬件资源消耗
- **高质量输出**：基于饱和度的对比度拉伸算法，避免传统暗通道方法的过饱和问题

### 技术亮点

1. **滤波器分解**：将15×15最小值滤波器分解为4级3×3滤波器级联，大幅降低比较器数量
2. **查找表优化**：使用LUT替代除法运算，提高处理速度
3. **下采样策略**：对大气光估计模块进行2倍下采样，减少行缓存需求
4. **定点数运算**：全定点数设计，避免浮点运算单元

---

## 算法流程

### 整体架构

```
输入图像 (H)
    ↓
┌───────────────────────────────────────────────────────┐
│ Stage 1: 预处理与下采样 (2x Downsample)              │
└───────────────────────────────────────────────────────┘
    ↓
┌───────────────────────────────────────────────────────┐
│ Stage 2-6: 大气光估计 (ALE Module)                    │
│  • Min3 (RGB最小值)                                   │
│  • 15×15 最小值滤波 (分解为4级3×3)                    │
│  • 暗通道最大值跟踪                                    │
│  • 大气光 A 估计                                       │
└───────────────────────────────────────────────────────┘
    ↓
┌───────────────────────────────────────────────────────┐
│ Stage 2: 图像归一化 (Hn = H / A)                      │
│  • 使用 LUT 实现 1/A 查找                             │
└───────────────────────────────────────────────────────┘
    ↓
┌───────────────────────────────────────────────────────┐
│ Stage 3: 饱和度估计                                   │
│  • K_Hn = mean(Hn_R, Hn_G, Hn_B)                      │
│  • min_Hn = min(Hn_R, Hn_G, Hn_B)                     │
│  • S_H = 1 - min_Hn / K_Hn (使用LUT)                  │
└───────────────────────────────────────────────────────┘
    ↓
┌───────────────────────────────────────────────────────┐
│ Stage 4: 对比度拉伸                                   │
│  • S_D = S_H × (2.0 - S_H)                            │
└───────────────────────────────────────────────────────┘
    ↓
┌───────────────────────────────────────────────────────┐
│ Stage 5-6: 透射率计算                                 │
│  • term = 1 - S_H / S_D (使用LUT)                     │
│  • t = 1 - ψ × K_Hn × term (ψ=1.25)                  │
└───────────────────────────────────────────────────────┘
    ↓
┌───────────────────────────────────────────────────────┐
│ Stage 7: 场景恢复                                     │
│  • D = (H - A) / t + A (使用LUT实现1/t)               │
└───────────────────────────────────────────────────────┘
    ↓
输出图像 (D)
```

### 关键公式

1. **饱和度估计**：`S_H = 1 - min(R,G,B) / mean(R,G,B)`
2. **对比度拉伸**：`S_D = S_H × (2 - S_H)`
3. **透射率计算**：`t = 1 - ψ × K × (1 - S_H/S_D)`，其中 ψ=1.25
4. **场景恢复**：`D = (H - A) / t + A`

---

## 硬件实现规划

### 模块划分

#### 1. 预处理模块 (Preprocessing)
**功能**：图像下采样与像素流分发

**输入**：
- `clk`, `rst_n`
- `valid_in`
- `r_in[7:0]`, `g_in[7:0]`, `b_in[7:0]`
- `h_cnt`, `v_cnt` (像素坐标)

**输出**：
- `valid_ds` (下采样有效信号，当 h_cnt%2==0 && v_cnt%2==0 时有效)
- `r_ds[7:0]`, `g_ds[7:0]`, `b_ds[7:0]` (下采样像素)
- `valid_full` (全分辨率有效信号)
- `r_full[7:0]`, `g_full[7:0]`, `b_full[7:0]` (全分辨率像素)

**实现要点**：
- 简单的计数器实现下采样逻辑
- 双路输出：一路给ALE模块(下采样)，一路给主处理流水线(全分辨率)

---

#### 2. 大气光估计模块 (ALE - Atmospheric Light Estimation)
**功能**：估计场景的大气光值 A

**子模块**：
- **Min3 模块**：计算RGB三通道的最小值
- **Min15x15 模块**：15×15最小值滤波器(分解为4级3×3)
- **Max Tracker 模块**：跟踪暗通道最大值及对应的RGB像素

**输入**：
- 下采样后的RGB像素流 (320×240 @ 8-bit)

**输出**：
- `A_R[7:0]`, `A_G[7:0]`, `A_B[7:0]` (大气光值，全局常量)
- `ale_done` (估计完成标志)

**实现要点**：
- 使用已完成的 `min9x9.v` 模块作为基础
- 需要扩展为15×15滤波器（5级3×3级联）
- Max Tracker 需要延迟对齐：RGB像素需延迟 `7×(WIDTH/2) + 15` 个周期
- 大气光值保护：`A = max(A, 100/255) ≈ max(A, 0.39)`

**当前完成度**：
- ✅ `min3x3.v` - 3×3最小值滤波器
- ✅ `min9x9.v` - 9×9最小值滤波器（4级3×3级联 + Min3）
- ⏳ 需扩展为 `min15x15.v` - 15×15最小值滤波器（5级3×3级联）
- ⏳ 需实现 `max_tracker.v` - 暗通道最大值跟踪器
- ⏳ 需实现 `pixel_delay.v` - RGB像素延迟对齐

---

#### 3. 归一化模块 (Normalization)
**功能**：计算 Hn = H / A

**输入**：
- `r_in[7:0]`, `g_in[7:0]`, `b_in[7:0]`
- `A_R[7:0]`, `A_G[7:0]`, `A_B[7:0]`

**输出**：
- `Hn_R[15:0]`, `Hn_G[15:0]`, `Hn_B[15:0]` (定点数，Q8.8格式)

**实现要点**：
- 使用LUT存储 `1/A` 的值（256项，每项16-bit）
- 乘法器：`Hn = H × (1/A)`
- 定点数格式：输入8-bit整数，输出16-bit定点数(Q8.8)

---

#### 4. 饱和度估计模块 (Saturation Estimation)
**功能**：计算 S_H = 1 - min(Hn) / mean(Hn)

**输入**：
- `Hn_R[15:0]`, `Hn_G[15:0]`, `Hn_B[15:0]`

**输出**：
- `S_H[15:0]` (定点数，Q1.15格式，范围0-1)
- `K_Hn[15:0]` (强度均值，用于后续计算)
- `min_Hn[15:0]` (最小值，用于后续计算)

**实现要点**：
- 加法器：`K_Hn = (Hn_R + Hn_G + Hn_B) / 3` (右移+舍入)
- 比较器：`min_Hn = min(Hn_R, Hn_G, Hn_B)`
- LUT：`1/K_Hn` 查找表（输入16-bit，输出16-bit）
- 乘法器：`S_H = 1 - min_Hn × (1/K_Hn)`
- 饱和保护：`K_Hn = max(K_Hn, epsilon)` 避免除零

---

#### 5. 对比度拉伸模块 (Contrast Stretching)
**功能**：计算 S_D = S_H × (2 - S_H)

**输入**：
- `S_H[15:0]`

**输出**：
- `S_D[15:0]` (定点数，Q1.15格式)

**实现要点**：
- 减法器：`2 - S_H`
- 乘法器：`S_H × (2 - S_H)`
- 定点数运算：Q1.15 × Q1.15 = Q2.30，截断为Q1.15
- 饱和保护：`S_D = max(S_D, epsilon)` 避免后续除零

---

#### 6. 透射率计算模块 (Transmission Calculation)
**功能**：计算 t = 1 - ψ × K_Hn × (1 - S_H/S_D)

**输入**：
- `S_H[15:0]`, `S_D[15:0]`, `K_Hn[15:0]`

**输出**：
- `t[15:0]` (定点数，Q1.15格式)

**实现要点**：
- LUT：`S_H / S_D` 查找表（或使用迭代除法器）
- 常数乘法器：`ψ = 1.25 = 5/4`，可用移位+加法实现
- 透射率限制：`t = clip(t, 0.1, 1.0)` 避免过度增强

---

#### 7. 场景恢复模块 (Scene Restoration)
**功能**：计算 D = (H - A) / t + A

**输入**：
- `r_in[7:0]`, `g_in[7:0]`, `b_in[7:0]`
- `A_R[7:0]`, `A_G[7:0]`, `A_B[7:0]`
- `t[15:0]`

**输出**：
- `r_out[7:0]`, `g_out[7:0]`, `b_out[7:0]`

**实现要点**：
- LUT：`1/t` 查找表（输入16-bit，输出16-bit）
- 减法器：`H - A`
- 乘法器：`(H - A) × (1/t)`
- 加法器：`result + A`
- 饱和处理：`D = clip(D, 0, 255)`

---

#### 8. 查找表模块 (LUT Modules)
**功能**：存储预计算的除法结果

**需要的LUT**：
1. **lut_inv_A**：`1/A` (256项 × 16-bit)
2. **lut_inv_K**：`1/K_Hn` (65536项 × 16-bit，可简化为分段LUT)
3. **lut_term**：`1 - 1/(2-S_H)` 或 `S_H/S_D` (65536项，可简化)
4. **lut_inv_t**：`1/t` (65536项 × 16-bit，可简化为分段LUT)

**实现要点**：
- 使用Block RAM实现大容量LUT
- 对于大型LUT，考虑分段线性插值减少存储需求
- 预计算Python脚本生成LUT初始化文件(.mem或.hex)

---

#### 9. 延迟对齐模块 (Delay Alignment)
**功能**：对齐不同处理路径的延迟

**关键延迟**：
- ALE模块：约 `2×IMG_WIDTH + 多级滤波器延迟`
- 主处理流水线：每个Stage约1-3个周期

**实现要点**：
- 使用FIFO或移位寄存器实现像素延迟
- 精确计算每个模块的延迟周期数
- 确保RGB像素、饱和度、透射率等信号时序对齐

---

### 资源估算

基于论文数据和当前设计：

| 模块 | LUT | FF | BRAM | DSP |
|------|-----|----|----|-----|
| Min15x15 (5级3×3) | ~2000 | ~1500 | 4-6 | 0 |
| 归一化 (LUT+乘法) | ~500 | ~200 | 1 | 3 |
| 饱和度估计 | ~800 | ~300 | 1-2 | 3 |
| 对比度拉伸 | ~300 | ~100 | 0 | 1 |
| 透射率计算 | ~600 | ~200 | 1 | 2 |
| 场景恢复 | ~500 | ~200 | 1 | 3 |
| 控制与延迟对齐 | ~1000 | ~500 | 2-4 | 0 |
| **总计** | **~5700** | **~3000** | **10-15** | **12** |

*注：以上为粗略估算，实际资源消耗取决于具体实现和优化*

---

## 当前RTL完成度

### ✅ 已完成模块

#### 1. `line_buf.v` - 行缓存模块
- **功能**：实现一行像素的延迟
- **特性**：
  - 循环缓冲区设计
  - 读写同地址时返回旧数据（Read-during-write）
  - 可配置深度和数据位宽
- **状态**：✅ 已完成并验证

#### 2. `min3x3.v` - 3×3最小值滤波器
- **功能**：计算3×3窗口内的最小值
- **特性**：
  - 使用2个行缓存存储前2行像素
  - 3×3窗口寄存器
  - 两级流水线：行最小值 → 全局最小值
  - 自动处理启动延迟（2×IMG_WIDTH + 2个周期）
- **状态**：✅ 已完成并验证

#### 3. `min9x9.v` - 9×9最小值滤波器
- **功能**：计算9×9窗口内的最小值（实际实现为15×15感受野）
- **特性**：
  - RGB三通道并行处理
  - 每通道4级3×3滤波器级联
  - 最终计算RGB的最小值（暗通道）
  - 有效信号自动传播
- **状态**：✅ 已完成并验证
- **注意**：当前实现为4级3×3级联，感受野为 `3 + 2×4 = 11`，接近9×9

#### 4. `top.v` - 顶层测试模块
- **功能**：实例化min9x9模块进行测试
- **状态**：✅ 已完成

---

### 模块清单 (TODO List)

#### 🔴 高优先级模块（ALE与基础设施）

- [x] **1. Min15x15滤波器**
  - 直接使用Min9x9替代
  - 验证感受野和延迟
  - 更新testbench
  - **依赖**：min3x3.v

- [ ] **2. 预处理模块** (`preprocess.v`)
  - 下采样逻辑（h_cnt%2==0 && v_cnt%2==0）
  - 像素流分发（下采样路径 + 全分辨率路径）
  - 坐标计数器
  - **依赖**：无

- [ ] **3. 像素延迟模块** (`pixel_delay.v`)
  - 可配置深度的移位寄存器/FIFO
  - 使能控制逻辑
  - 延迟深度：`7×(WIDTH/2) + 15` 个周期
  - **依赖**：无

- [ ] **4. Max Tracker模块** (`max_tracker.v`)
  - 暗通道最大值比较器
  - RGB像素锁存器
  - 地址/索引记录（可选）
  - 大气光保护：`A = max(A, 100/255)`
  - **依赖**：pixel_delay.v

- [ ] **5. LUT生成器** (Python脚本 + `luts.v`)
  - Python脚本生成.mem文件
  - LUT 1: `1/A` (256项 × 16-bit)
  - LUT 2: `1/K_Hn` (分段LUT或完整65536项)
  - LUT 3: `S_H/S_D` 或 `1-1/(2-S_H)` (分段LUT)
  - LUT 4: `1/t` (分段LUT)
  - Verilog LUT读取模块
  - **依赖**：无

#### � 中优先级模块（主处理流水线）

- [ ] **6. 归一化模块** (`normalize.v`)
  - LUT实例化：`1/A`
  - RGB三通道乘法器
  - 定点数处理（输入8-bit → 输出Q8.8）
  - 单元测试
  - **依赖**：luts.v

- [ ] **7. 饱和度估计模块** (`saturation_est.v`)
  - 加法器：`K_Hn = (R+G+B)/3`
  - 比较器：`min_Hn = min(R,G,B)`
  - LUT查找：`1/K_Hn`
  - 饱和度计算：`S_H = 1 - min_Hn × (1/K_Hn)`
  - 饱和保护：避免除零
  - 单元测试
  - **依赖**：luts.v

- [ ] **8. 对比度拉伸模块** (`contrast_stretch.v`)
  - 减法器：`2 - S_H`
  - 乘法器：`S_H × (2 - S_H)`
  - 定点数截断（Q2.30 → Q1.15）
  - 饱和保护：`S_D = max(S_D, epsilon)`
  - 单元测试
  - **依赖**：无

- [ ] **9. 透射率计算模块** (`transmission_calc.v`)
  - LUT查找：`S_H/S_D` 或除法器
  - 常数乘法：`ψ = 1.25 = 5/4`（移位+加法）
  - 透射率计算：`t = 1 - ψ × K_Hn × (1 - S_H/S_D)`
  - 透射率限制：`t = clip(t, 0.1, 1.0)`
  - 单元测试
  - **依赖**：luts.v

- [ ] **10. 场景恢复模块** (`scene_restore.v`)
  - LUT查找：`1/t`
  - RGB三通道处理
  - 减法器：`H - A`
  - 乘法器：`(H - A) × (1/t)`
  - 加法器：`result + A`
  - 饱和限制：`D = clip(D, 0, 255)`
  - 单元测试
  - **依赖**：luts.v

#### 🟢 低优先级模块（集成与优化）

- [ ] **11. ALE顶层模块** (`ale_top.v`)
  - 集成min15x15、max_tracker、pixel_delay
  - 延迟对齐验证
  - 与Python参考模型对比测试
  - **依赖**：min15x15.v, max_tracker.v, pixel_delay.v

- [ ] **12. 延迟对齐网络** (`delay_align.v`)
  - 计算每个模块的精确延迟
  - 插入延迟匹配FIFO/寄存器
  - 波形验证时序对齐
  - **依赖**：所有处理模块

- [ ] **13. 去雾顶层模块** (`dehaze_top.v`)
  - 实例化所有子模块
  - 信号互连
  - 控制逻辑（复位、使能）
  - 顶层接口定义
  - **依赖**：所有子模块

---

## 实现清单

### Phase 1: ALE模块完成 (大气光估计)

- [ ] **1.1** 扩展min9x9为min15x15
  - [ ] 增加第5级min3x3实例
  - [ ] 验证感受野和延迟
  - [ ] 更新testbench

- [ ] **1.2** 实现pixel_delay模块
  - [ ] 可配置深度的移位寄存器/FIFO
  - [ ] 使能控制逻辑
  - [ ] 单元测试

- [ ] **1.3** 实现max_tracker模块
  - [ ] 暗通道最大值比较器
  - [ ] RGB像素锁存器
  - [ ] 地址/索引记录（可选）
  - [ ] 单元测试

- [ ] **1.4** 实现preprocess模块
  - [ ] 下采样计数器
  - [ ] 双路输出逻辑
  - [ ] 单元测试

- [ ] **1.5** 集成ALE顶层模块
  - [ ] 连接min15x15、max_tracker、pixel_delay
  - [ ] 延迟对齐验证
  - [ ] 与Python参考模型对比测试

---

### Phase 2: 主处理流水线 (Stage 2-7)

- [ ] **2.1** 实现LUT生成器
  - [ ] Python脚本：生成1/A, 1/K, 1/t等LUT
  - [ ] .mem文件生成
  - [ ] Verilog LUT读取模块

- [ ] **2.2** 实现normalize模块
  - [ ] LUT实例化
  - [ ] 乘法器
  - [ ] 定点数处理
  - [ ] 单元测试

- [ ] **2.3** 实现saturation_est模块
  - [ ] 加法器（均值）
  - [ ] 比较器（最小值）
  - [ ] LUT: 1/K
  - [ ] 饱和度计算
  - [ ] 单元测试

- [ ] **2.4** 实现contrast_stretch模块
  - [ ] 减法器：2 - S_H
  - [ ] 乘法器：S_H × (2 - S_H)
  - [ ] 定点数截断
  - [ ] 单元测试

- [ ] **2.5** 实现transmission_calc模块
  - [ ] LUT: S_H/S_D（或除法器）
  - [ ] 常数乘法：ψ = 1.25
  - [ ] 透射率限制
  - [ ] 单元测试

- [ ] **2.6** 实现scene_restore模块
  - [ ] LUT: 1/t
  - [ ] RGB三通道处理
  - [ ] 饱和限制
  - [ ] 单元测试

---

### Phase 3: 顶层集成与优化

- [ ] **3.1** 实现dehaze_top顶层模块
  - [ ] 实例化所有子模块
  - [ ] 信号互连
  - [ ] 延迟对齐网络

- [ ] **3.2** 延迟对齐验证
  - [ ] 计算每个模块的精确延迟
  - [ ] 插入延迟匹配模块
  - [ ] 波形验证

- [ ] **3.3** 功能验证
  - [ ] 使用haze.jpg进行仿真
  - [ ] 与Python参考模型逐像素对比
  - [ ] 误差分析

- [ ] **3.4** 性能优化
  - [ ] 流水线平衡
  - [ ] 关键路径优化
  - [ ] 资源优化

- [ ] **3.5** FPGA综合与实现
  - [ ] 选择目标FPGA平台
  - [ ] 约束文件编写
  - [ ] 时序收敛
  - [ ] 资源利用率报告

---

### Phase 4: 测试与文档

- [ ] **4.1** 完善testbench
  - [ ] 图像读取与写入
  - [ ] 自动化验证脚本
  - [ ] 覆盖率分析

- [ ] **4.2** 性能测试
  - [ ] 吞吐量测试
  - [ ] 延迟测试
  - [ ] 功耗估算

- [ ] **4.3** 文档完善
  - [ ] 模块接口文档
  - [ ] 时序图
  - [ ] 用户手册

- [ ] **4.4** 代码清理
  - [ ] 代码规范检查
  - [ ] 注释完善
  - [ ] 版本发布

---

## 开发环境

### 工具链

- **仿真器**：Verilator 5.x
- **编译器**：GCC/Clang (C++14或更高)
- **构建工具**：Make
- **Python**：3.8+ (用于参考算法和LUT生成)
- **依赖库**：OpenCV, NumPy, Matplotlib

### 目录结构

```
DehazeAlgo/
├── rtl/                    # RTL源代码
│   ├── line_buf.v         # 行缓存模块
│   ├── min3x3.v           # 3×3最小值滤波器
│   ├── min9x9.v           # 9×9最小值滤波器
│   ├── top.v              # 顶层测试模块
│   └── (待添加更多模块)
├── sim/                    # 仿真文件
│   ├── sim_main.cpp       # Verilator testbench
│   ├── Makefile           # 构建脚本
│   └── obj_dir/           # 编译输出
├── scripts/                # 工具脚本
│   └── (待添加LUT生成脚本)
├── docs/                   # 文档
│   └── VLSI_Design_of_Saturation-Based_Image_Dehazing_Algorithm.pdf
├── main.py                 # Python参考算法
├── hardware.md             # 硬件实现笔记
├── haze.jpg                # 测试图像
└── README.md               # 本文件
```

---

## 快速开始

### 1. 运行Python参考算法

```bash
# 创建虚拟环境
python3 -m venv .venv
source .venv/bin/activate

# 安装依赖
pip install opencv-python numpy matplotlib

# 运行去雾算法
python main.py
```

### 2. 编译并运行RTL仿真

```bash
cd sim

# 编译Verilator仿真
make

# 运行仿真（当前测试min9x9模块）
./obj_dir/Vtop

# 查看仿真日志
tail -f sim_log.txt
```

### 3. 查看波形（可选）

```bash
# 如果启用了VCD波形导出
gtkwave waveform.vcd
```

---

## 参考资料

### 论文

- **主要参考**：*VLSI Design of Saturation-Based Image Dehazing Algorithm*
  - 文件路径：`VLSI_Design_of_Saturation-Based_Image_Dehazing_Algorithm.pdf`
  - 关键章节：
    - Section III: Algorithm Description
    - Section IV: Hardware Architecture
    - Section V: Implementation Results

### 关键引用

- **[cite: 91, 217]**：行缓存与像素流处理
- **[cite: 213, 219, 226]**：滤波器分解策略
- **[cite: 195, 335]**：查找表优化
- **[cite: 279, 284]**：硬件友好的对比度拉伸公式
- **[cite: 427]**：透射率系数 ψ=1.25

---

## 贡献指南

### 代码规范

1. **命名规范**：
   - 模块名：小写下划线（如 `min3x3.v`）
   - 信号名：小写下划线（如 `valid_out`）
   - 参数名：大写下划线（如 `DATA_WIDTH`）

2. **注释规范**：
   - 每个模块顶部说明功能、接口、延迟
   - 关键算法添加公式和论文引用
   - 复杂逻辑添加时序说明

3. **提交规范**：
   - 提交信息格式：`[模块名] 简短描述`
   - 每次提交包含对应的测试

### 测试要求

- 每个新模块必须包含单元测试
- 与Python参考模型对比验证
- 提供波形截图或日志

---

## 许可证

本项目仅供学习和研究使用。

---

## 联系方式

如有问题或建议，请提交Issue或Pull Request。

---

**最后更新**：2025-11-19
